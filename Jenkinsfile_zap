#!groovy

@Library("zapUtils") _
 
import com.oui.technologies.*

pipeline {
    agent {
        node {
            label 'maven'
        }
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    stages {
        stage("Pull Project") {
            steps {
                script {
                    git(url: 'https://github.com/voyages-sncf-technologies/hesperides.git',
                        credentialsId: 'github-hesperides-adm',
                        branch: 'develop')
                }
            }
        }
        stage('Run integration tests through ZAP proxy') {
            steps {
                script {
                    sh 'nohup mvn spring-boot:run -pl bootstrap -Dspring.profiles.active=fake_mongo,noldap &'
                    // TODO: wait + cleanup (kill)
                    sh 'while ! curl --fail http://localhost:8080/rest/manage/health; do sleep 5; cat nohup.out; done'
                    def zapTest = new zapUtils(this)
                    def mvnCmd = 'mvn verify -pl tests/integration -Dexec.mainClass=org.hesperides.test.integration.CucumberIntegTests -Dintegration-bdd.proxy-host=localhost -Dintegration-bdd.proxy-port=3128'
                    zapTest.runOrder('java', 8, mvnCmd, 'LCimon@oui.sncf', 'http://localhost:8080/rest', false)
                }
            }
        }
    }
    post {
        always {
            deleteDir()
        }
    }
}
