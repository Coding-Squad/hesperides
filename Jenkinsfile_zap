#!groovy

@Library("zapUtils") _
 
import com.oui.technologies.*

pipeline {
    agent {
        node {
            label 'maven'
        }
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    stages {
        stage('Run integration tests through ZAP proxy') {
            steps {
                script {
                    sh 'nohup mvnw spring-boot:run -pl bootstrap -Dspring.profiles.active=fake_mongo,noldap &'
                    // TODO: wait + cleanup (kill)
                    sh 'sleep 30'
                    def mvnCmd = 'mvn verify -pl tests/integration -Dexec.mainClass=org.hesperides.test.integration.CucumberIntegTests'
                           + "-Dintegration-bdd.proxy-host=localhost -Dintegration-bdd.proxy-port=3128"
                    def zapTest = new zapUtils(this)
                    zapTest.runOrder('java', 8, mvnCmd, 'LCimon@oui.sncf', 'http://localhost:8080/rest', false)
                }
            }
        }
    }
    post {
        always {
            deleteDir()
        }
    }
}
