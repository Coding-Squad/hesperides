#!groovy

@Library(["github"]) _

pipeline {
    agent {
        node {
            label 'maven3'
        }
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    parameters {
        string(name: 'RELEASE_VERSION', description: 'Release Version')
        string(name: 'NEXT_SNAPSHOT_VERSION', description: 'Next Snapshot Version')
    }
    stages {
        stage("Pull Project") {
            steps {
                script {
                    git(
                            url: 'https://github.com/voyages-sncf-technologies/hesperides.git',
                            credentialsId: 'github-hesperides-adm',
                            branch: 'develop'
                    )
                }
            }
        }
        stage("Create release branch") {
            steps {
                script {
                    withMaven(mavenSettingsConfig: 'global_maven_settings') {
                        sh "mvn help:effective-settings"
                        sh "mvn -B gitflow:release-start -DreleaseVersion=${params.RELEASE_VERSION} -DdevelopmentVersion=${params.NEXT_SNAPSHOT_VERSION}"
                    }
                    withCredentials([usernamePassword(credentialsId: 'github-hesperides-adm', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                        sh "git config user.name \"hesperides-adm\""
                        sh "git push https://${USERNAME}:${PASSWORD}@github.com/voyages-sncf-technologies/hesperides.git release/${params.RELEASE_VERSION}"
                    }
                }
            }
        }
        stage('Create GitHub Release') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'github-hesperides-adm-token', variable: 'TOKEN_ID', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                        github.authenticate organization: 'voyages-sncf-technologies', project: 'hesperides', token: "${TOKEN_ID}"
                        github.createRelease tag: "v${params.RELEASE_VERSION}", branch: "release/${params.RELEASE_VERSION}", description: "${params.RELEASE_VERSION}", draft: false, prerelease: false
                        sh "git merge release/${params.RELEASE_VERSION} develop"
                        sh "git config user.name \"hesperides-adm\""
                        sh "git push https://${USERNAME}:${PASSWORD}@github.com/voyages-sncf-technologies/hesperides.git develop"
                    }
                }
            }
        }
    }

    post {
        always {
            deleteDir()
        }
    }
}
