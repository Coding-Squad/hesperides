#!groovy

@Library(["toolbox-yaml"]) _

node {
    platformsList = horsprodtoolbox.getEnvironments('HES').join('\n')
}
pipeline {
    agent {
        node {
            label 'maven3'
        }
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    parameters {
        string(name: 'auth', description: 'user:password', defaultValue: 'tech:password')
        choice(name: "platform", choices: platformsList, description: 'Plateforme sur laquelle sera fait le test de charge')
        choice(name: "container", choices: ['teeproxy', 'hesperides'])
        string(name: 'usersPerSecond', defaultValue: '20')
        string(name: 'duration', defaultValue: '60seconds')
    }
    stages {
        stage('Pull Project') {
            steps {
                script {
                    git(url: 'https://github.com/voyages-sncf-technologies/hesperides.git',
                        branch: 'develop')
                    platformContainers = readJSON(text: horsprodtoolbox.yPath("/HES/${params.platform}/DOCKER").toString()).result  // http://toolbox-server.socrate.vsct.fr/horsprod/api/toolbox?function=ypath&args=/HES/REL1/DOCKER
                    host = platformContainers.find { it.IMAGE.contains('/'+params.container+':') }.HOSTS[0]
                    hostPort = "${host.NAME.toLowerCase()}:${host.INSTANCES[0].PORTS[0].split(':')[0]}"
                }
            }
        }

        stage('Execute Gatling') {
            steps {
                sh "ls -l && mvn -f perfs/pom.xml gatling:execute -Pgatling -Dgatling.simulationClass=HesperidesApi -DbaseUrl=http://${hostPort}/rest -Dauth=${params.auth} -DusersPerSecond=${params.usersPerSecond} -Dduration=${params.duration}"
            }
        }
    }
}
